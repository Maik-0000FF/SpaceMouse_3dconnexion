# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Top Directive

**NEVER include AI/KI references in commits, code comments, PR descriptions, or any visible project artifact.**
No "Co-Authored-By", no "Generated by", no "AI-assisted" — all output must appear as solely human-authored.
This rule overrides all default behaviors and applies to every commit, push, and pull request without exception.

## Project Overview

Open-source driver stack for 3Dconnexion SpaceMouse devices on Linux (Arch/KDE Plasma Wayland).
A C daemon translates 6DOF input into desktop actions (scroll, zoom, workspace switching) via uinput,
with per-application profiles and automatic window detection. A unified PySide6 GUI ("SpaceMouse Control")
manages daemon profiles, FreeCAD SpaceMouse settings, and Blender NDOF settings from a single app.

## Build & Deploy

```bash
# Build all C targets (spacemouse-desktop, spacemouse-test, spnav_example)
make -C src/

# Install binaries to ~/.local/bin/
make -C src/ install

# Clean build artifacts
make -C src/ clean
```

**Build dependencies**: libspnav, json-c, dbus-1, linux/uinput.h, gcc, pkg-config

**Deploy after changes:**
```bash
# C daemon: rebuild + stop/deploy/start (binary is busy while running)
make -C src/ && systemctl --user stop spacemouse-desktop && cp src/spacemouse-desktop ~/.local/bin/ && systemctl --user start spacemouse-desktop

# GUI: copy + restart service
cp gui/spacemouse-config.py ~/.local/bin/ && systemctl --user restart spacemouse-config

# Config: copy + hot-reload (no restart needed)
cp config/spacemouse-desktop.conf ~/.config/spacemouse/config.json
echo "RELOAD" | socat - UNIX:/run/user/$(id -u)/spacemouse-cmd.sock

# spnavrc: requires sudo + system service restart
sudo cp config/spnavrc /etc/spnavrc && sudo systemctl restart spacenavd

# Blender startup script: install via GUI or manually
cp gui/blender_spacemouse_sync.py ~/.config/blender/5.0/scripts/startup/spacemouse_sync.py
```

**Diagnostics:**
```bash
spacemouse-test --check   # System checks (USB, spacenavd, uinput)
spacemouse-test --live    # Real-time axis/button monitor
spacemouse-test --led     # LED toggle test
```

## Architecture

```
SpaceMouse (USB HID)
    → spacenavd (system daemon, /var/run/spnav.sock)
    → libspnav (client library, multiplexes to ALL connected clients)
    → Parallel consumers:
        ├── spacemouse-desktop (C daemon: uinput + D-Bus)
        ├── Blender / FreeCAD (native 3D navigation)
        └── spacemouse-config (PySide6 GUI: unified control app)
```

**spacemouse-desktop.c** — The C daemon is the core. poll()-based event loop reads libspnav events
and the command socket simultaneously. Applies per-profile axis mapping, deadzone, nonlinear response
curve (exponent), then emits uinput wheel events (REL_WHEEL_HI_RES) for scroll/zoom or calls
KWin D-Bus methods for desktop switching. Zoom is emitted as Ctrl+scroll. Profiles where all axes
and buttons are `none` are auto-detected as "passthrough" — events are drained without processing
(zero CPU overhead). A built-in `_passthrough` profile is always available for GUI use.

**spacemouse-config.py** — Unified PySide6 GUI ("SpaceMouse Control") with dark theme and sidebar
navigation. Three pages: Desktop (daemon profiles), FreeCAD (user.cfg XML editing), Blender
(NDOF JSON settings). System tray icon, live axis preview bar, automatic window detection via
KWin D-Bus + journalctl, daemon socket communication. Apple-style animated toggle switches
(custom `ToggleSwitch` QWidget with `QPropertyAnimation`). Smart focus management: when the
settings window is focused, daemon switches to `_passthrough` (no desktop actions interfere
with configuration). When the window loses focus (user clicks on desktop), the daemon restores
the normal profile so settings can be tested. SpnavReader is only active when the GUI is
visible (event-driven via `select()` on spnav fd), suspended otherwise for zero CPU usage.

**blender_spacemouse_sync.py** — Blender startup script. Installed to
`~/.config/blender/5.0/scripts/startup/`. Reads `~/.config/spacemouse/blender-ndof.json` at
Blender startup and applies all NDOF settings to `bpy.context.preferences.inputs` via
`bpy.app.timers` (deferred because `bpy.context` isn't available at import time).

**Daemon command socket** at `/run/user/<UID>/spacemouse-cmd.sock` — line-based text protocol:
`PROFILE <name>`, `RELOAD`, `STATUS`. The `_passthrough` profile is always available (built-in).

## GUI Structure (spacemouse-config.py)

```
┌─────────────────────────────────────────────────┐
│  SpaceMouse Control                              │
├──────────┬──────────────────────────────────────┤
│ Sidebar  │  Content (QStackedWidget)             │
│          │                                       │
│ [Desktop]│  Cards with sliders, combos, toggles  │
│ [FreeCAD]│  per selected page                    │
│ [Blender]│                                       │
│          │                     [ Apply ]         │
│ Autostart│                                       │
├──────────┴──────────────────────────────────────┤
│ Live: TX[━] TY[━] TZ[━] RX[━] RY[━] RZ[━]      │
│ Buttons: ○ ○          Profile: default    ●      │
└─────────────────────────────────────────────────┘
```

Key classes:
- **`ToggleSwitch`** — Custom QWidget, Apple-style animated pill toggle (QPainter + QPropertyAnimation)
- **`DesktopPage`** — Daemon profile editor with profile selector dropdown, speed/sensitivity sliders,
  axis/button dropdowns, invert toggles, desktop switch settings
- **`FreeCADPage`** — Reads/writes FreeCAD `user.cfg` XML via `FreeCADConfig` class. Sensitivity slider,
  6 axis enable/invert toggles, FlipYZ, Dominant mode, button command dropdowns, nav/orbit style
- **`BlenderPage`** — Reads/writes `blender-ndof.json` via `BlenderConfig` class. Sensitivity/orbit/deadzone
  sliders, Lock Horizon toggle (with warning), Y/Z swap, zoom invert, 6 rotation+pan axis inversions.
  Startup script installer button
- **`LivePreviewBar`** — Compact horizontal bar at bottom with 6 axis bars (real-time, no throttling),
  button indicators, profile name, daemon status dot
- **`FreeCADConfig`** — XML read/write for FreeCAD user.cfg. Same helpers as `freecad-spacemouse-patch.sh`
  (`find_group`, `ensure_group`, `set_bool`, `set_int`, `set_text`) plus getters
- **`BlenderConfig`** — JSON read/write for `blender-ndof.json` + startup script management
- **`SpnavReader`** — QThread, libspnav ctypes bindings, event-driven via `select()` on `spnav_fd()`.
  Suspendable: `set_suspended(True/False)` — when suspended, drains events without emitting signals
  (zero CPU). Active only when GUI window is visible. Emits every motion event individually for
  smooth real-time display (no coalescing).
- **`WindowMonitor`** — QThread, KWin D-Bus script + journalctl stream, automatic profile switching
- **`SettingsWindow`** — Emits `window_shown`/`window_hidden` (SpnavReader suspend/resume) and
  `window_focused`/`window_unfocused` (daemon passthrough toggle via `changeEvent(ActivationChange)`)

## Config Files

```
~/.config/spacemouse/
├── config.json              ← Daemon profiles (desktop page)
└── blender-ndof.json        ← Blender NDOF settings (blender page)

~/.config/FreeCAD/user.cfg   ← FreeCAD settings (freecad page writes XML directly)

~/.config/blender/5.0/scripts/startup/
└── spacemouse_sync.py       ← Blender startup script (reads blender-ndof.json)
```

## Profile System

Config lives at `~/.config/spacemouse/config.json`. Source of truth in repo: `config/spacemouse-desktop.conf`.

5 config profiles: `default`, `blender`, `freecad`, `browser`, `filemanager` + 1 built-in:
`_passthrough` (auto-generated by daemon, used by GUI when settings window is focused).

Each has `match_wm_class`, `deadzone`, `scroll_speed`, `scroll_exponent`, `zoom_speed`,
`desktop_switch_threshold`, `desktop_switch_cooldown_ms`, `axis_mapping` (6 axes),
`button_mapping` (2 buttons), `invert_scroll_x/y`.

- Axis actions: `none`, `scroll_h`, `scroll_v`, `zoom`, `desktop_switch`
- Button actions: `none`, `overview`, `show_desktop`
- Blender/FreeCAD profiles set all axes to `none` — lets native 3D nav work without double-input conflicts
- Profiles with all axes+buttons `none` are auto-flagged as `passthrough` — daemon skips event processing entirely

## Resource Management

Only the focused application actively processes SpaceMouse events. All other consumers go idle:

| Focused Window | Daemon | GUI SpnavReader | 3D App |
|----------------|--------|----------------|--------|
| Desktop app | Active (scroll/zoom/workspace) | Suspended | N/A |
| Blender/FreeCAD | Passthrough (idle) | Suspended if GUI hidden, active if visible | Active (3D nav) |
| Settings GUI | `_passthrough` (idle) | Active (live preview) | Background |
| GUI open, desktop clicked | Normal profile (active) | Active (live preview) | Background |

**Implementation details:**
- Daemon: `passthrough` flag auto-detected per profile at config load time. Event loop skips
  all processing (just drains socket) for passthrough profiles.
- GUI: `SpnavReader.set_suspended()` toggles between active (select+emit) and suspended (sleep+drain).
  `SettingsWindow` signals: `window_shown`/`window_hidden` control reader, `window_focused`/`window_unfocused`
  control daemon profile via `PROFILE _passthrough` / `PROFILE <saved>`
- SpnavReader uses `select()` on `spnav_fd()` — true event-driven I/O, zero CPU when no events arrive

## Window Detection (KWin Wayland)

The GUI loads a persistent KWin JavaScript via D-Bus that hooks `workspace.windowActivated`
and prints `SPACEMOUSE_WM:<resourceClass>` to the journal. The GUI follows
`journalctl --user -t kwin_wayland -f` and sends `PROFILE <name>` to the daemon on match.

**Critical KWin API caveats:**
- `queryWindowInfo` requires a user click — NOT usable for auto-detection
- `evaluateScript` does NOT exist on this KDE Plasma version
- Correct approach: `loadScript` via D-Bus + read output from journalctl

## FreeCAD SpaceMouse Patches

Two minimal C++ patches fix jerky SpaceMouse navigation on Linux.
Technical reference in `docs/FREECAD_SPACEMOUSE_FIX.md`.

### Root Cause

FreeCAD's Linux spnav event pipeline has two bugs:
1. **No event coalescing** — `pollSpacenav()` posts every event (125-250Hz) individually, each triggering a redraw
2. **Double redraws** — `camera->orientation` and `camera->position` each trigger separate Coin3D notifications

Combined: up to 500 redraws/sec. On Windows/macOS, NavLib SDK handles this internally. On Linux, NavLib is disabled in CMake.

### Patch Files

| File | Location | Purpose |
|------|----------|---------|
| `spacemouse-smooth-navigation.patch` | `freecad-patches/` | Git-format unified diff (+13/-3 lines) |
| `apply-spacemouse-fix.py` | `freecad-patches/` AND `freecad-pacman-build/` | Pattern-based Python patcher (version-agnostic) |

**Patch 1 — Event Coalescing** (`GuiNativeEventLinux.cpp`):
Drain loop keeps only the latest motion state, posts once per poll cycle. SpaceMouse events are absolute deflection, not deltas, so latest = complete state.

**Patch 2 — Batched Camera Updates** (`NavigationStyle.cpp`):
Wraps camera property changes in `enableNotify(false/true)` + `touch()` for single Coin3D redraw.

### FreeCAD Build Methods

**Method A — Arch pacman package (recommended):**
```bash
cd freecad-pacman-build && makepkg -sfi
```

The `PKGBUILD` (in `freecad-pacman-build/`) is the official Arch PKGBUILD with additions:
- `_build_version` variable at top: `"stable"` (1.0.2) or `"rc"` (1.1rc2)
- `source=()` includes `apply-spacemouse-fix.py`
- `prepare()` conditionally applies version-specific patches (OpenCascade, Boost, cherry-picks for 1.0.x only),
  then runs `python3 ../apply-spacemouse-fix.py .` (works on all versions)
- Also includes `fix-opencascade-7.9.patch` and `boost-1.89.patch` for 1.0.x Arch compatibility
- After system updates overwrite FreeCAD, rebuild with `cd freecad-pacman-build && makepkg -sfi`

**Method B — Source build:**
```bash
./scripts/freecad-build-patched.sh --clone 1.0.2   # Clone + patch + build
./scripts/freecad-build-patched.sh                  # Rebuild existing source
./scripts/freecad-build-patched.sh --install        # Build + install to ~/.local
```
Binary at `freecad-build/build/bin/FreeCAD` (doesn't replace system FreeCAD).

**Method C — Manual patching (any version):**
```bash
python3 freecad-patches/apply-spacemouse-fix.py /path/to/freecad-source
python3 freecad-patches/apply-spacemouse-fix.py --check /path/to/freecad-source  # dry-run
```
Pattern-based, no line numbers — finds `mainApp->postMotionEvent` and `camera->orientation.setValue(newRotation)` patterns.

### FreeCAD Scripts

| Script | Purpose |
|--------|---------|
| `scripts/freecad-spacemouse-patch.sh` | Configures FreeCAD `user.cfg` (navigation style, axes, sensitivity, buttons). Now also available via GUI FreeCAD page |
| `scripts/freecad-build-patched.sh` | Clone + patch + cmake/ninja build from source |
| `scripts/freecad-pacman-build.sh` | Downloads Arch PKGBUILD, injects patch, runs `makepkg` |
| `scripts/freecad-spacemouse-setup.FCMacro` | FreeCAD macro for manual setup (legacy) |

### Event Pipeline Reference

```
SpaceMouse (USB HID)
  → spacenavd (125-250Hz) → libspnav fd → QSocketNotifier
  → pollSpacenav()                   ← PATCH 1: coalesce to 1 event per poll
    → postMotionEvent() → importSettings() → QApplication::postEvent()
  → Qt Event Loop → translateEvent() → SoMotion3Event
  → processMotionEvent()             ← PATCH 2: enableNotify(false/true) + touch()
    → single Coin3D redraw (~60fps)
```

### Failed Approaches

1. Custom processMotionEvent with deadzone/smoothing/curves — root cause was the pipeline, not processMotionEvent
2. SoFieldSensor + focalDistance Python addon — worked but conflicted with C++ patches
3. BBox center as rotation pivot — SoGetBoundingBoxAction too expensive at 60Hz
4. SoMotion3Event interception via SoEventCallback — events never reach scene graph
5. Separate spnav connection — `spnav_open()` allows only ONE connection per process

**SpaceNavFix Python addon is disabled** (`~/.local/share/FreeCAD/Mod/SpaceNavFix.disabled/`).
Do not re-enable — it conflicts with the C++ patches.

**Sensitivity tuning** — Use the FreeCAD page in SpaceMouse Control GUI, or via FreeCAD Python console:
```python
p = FreeCAD.ParamGet("User parameter:BaseApp/Preferences/Spaceball/Motion")
p.SetInt("GlobalSensitivity", -15)
```

## FreeCAD Config XML Structure

The `FreeCADConfig` class navigates this XML hierarchy in `user.cfg`:

```
<FCParameters>
  <FCParamGroup Name="Root">
    <FCParamGroup Name="BaseApp">
      <FCParamGroup Name="Preferences">
        <FCParamGroup Name="View">
          ← NavigationStyle (FCText), OrbitStyle (FCInt), LegacySpaceMouseDevices (FCBool)
      <FCParamGroup Name="Spaceball">
        <FCParamGroup Name="Motion">
          ← GlobalSensitivity (FCInt), FlipYZ/Dominant (FCBool), axis Enable/Reverse (FCBool)
        <FCParamGroup Name="Buttons">
          <FCParamGroup Name="0">  ← Command (FCText)
          <FCParamGroup Name="1">  ← Command (FCText)
```

**Important**: FreeCAD overwrites `user.cfg` on exit. The GUI warns if FreeCAD is running.
Note: there are TWO `Spaceball` groups — one under `BaseApp/Preferences/Spaceball` (empty/unused)
and one under `BaseApp/Spaceball` (the real one). The code uses `BaseApp/Spaceball`.

## Blender NDOF Settings

`blender-ndof.json` maps directly to `bpy.context.preferences.inputs.*` properties:

| JSON key | bpy property | Type | Default |
|----------|-------------|------|---------|
| `ndof_sensitivity` | `ndof_sensitivity` | float 0.0–4.0 | 1.0 |
| `ndof_orbit_sensitivity` | `ndof_orbit_sensitivity` | float 0.0–4.0 | 1.0 |
| `ndof_deadzone` | `ndof_deadzone` | float 0.0–1.0 | 0.1 |
| `ndof_lock_horizon` | `ndof_lock_horizon` | bool | False |
| `ndof_pan_yz_swap_axis` | `ndof_pan_yz_swap_axis` | bool | False |
| `ndof_zoom_invert` | `ndof_zoom_invert` | bool | False |
| `ndof_rot{x,y,z}_invert_axis` | `ndof_rot{x,y,z}_invert_axis` | bool | False |
| `ndof_pan{x,y,z}_invert_axis` | `ndof_pan{x,y,z}_invert_axis` | bool | False |

## Repository Structure

```
├── src/                          C daemon + test tool
│   ├── spacemouse-desktop.c      Main daemon (uinput + D-Bus)
│   ├── spacemouse-test.c         Diagnostic tool
│   └── Makefile
├── gui/
│   ├── spacemouse-config.py      Unified control app (PySide6)
│   ├── blender_spacemouse_sync.py  Blender startup script
│   └── spacemouse-config.desktop Desktop entry
├── config/
│   ├── spacemouse-desktop.conf   Default daemon config (→ config.json)
│   └── spnavrc                   spacenavd config
├── freecad-patches/
│   ├── spacemouse-smooth-navigation.patch  Unified diff
│   └── apply-spacemouse-fix.py   Pattern-based Python patcher
├── freecad-pacman-build/
│   ├── PKGBUILD                  Arch package build (official + patches)
│   ├── apply-spacemouse-fix.py   Copy of patcher for PKGBUILD
│   ├── fix-opencascade-7.9.patch Arch compat patch
│   ├── boost-1.89.patch          Arch compat patch
│   └── spacemouse-smooth-navigation.patch  Copy for PKGBUILD
├── scripts/
│   ├── freecad-spacemouse-patch.sh   Configure FreeCAD user.cfg
│   ├── freecad-build-patched.sh      Clone + patch + build from source
│   ├── freecad-pacman-build.sh       Download PKGBUILD + inject patch + makepkg
│   └── freecad-spacemouse-setup.FCMacro  Legacy FreeCAD macro
├── docs/
│   └── FREECAD_SPACEMOUSE_FIX.md Technical reference
├── install.sh                    Full installer
├── uninstall.sh                  Full uninstaller
└── CLAUDE.md                     This file
```

## Known Gotchas

- FreeCAD requires `LegacySpaceMouseDevices = 1` in user.cfg for SpaceNavigator (046d:c626)
- FreeCAD WM class is `org.freecad.FreeCAD` (not just "freecad")
- FreeCAD SpaceMouse jerkiness on Linux is caused by the event pipeline (no coalescing), not by `processMotionEvent()` — see `docs/FREECAD_SPACEMOUSE_FIX.md`
- FreeCAD overwrites user.cfg on exit — close FreeCAD before editing via GUI
- Blender's `ndof_lock_horizon = True` (default) blocks the RX/pitch axis entirely — must be False
- Blender cannot save preferences in `--background` mode (crashes on `bpy.ops.wm.save_userpref()`)
- Blender startup script uses `bpy.app.timers` because `bpy.context` is not available at import time
- spnavrc changes require `sudo systemctl restart spacenavd`
- GUI systemd service auto-restarts on crash — use "Quit (stop all)" from tray to fully stop
- C daemon binary is busy while running — stop service before deploying: `systemctl --user stop spacemouse-desktop && cp ... && systemctl --user start spacemouse-desktop`
- GUI SpnavReader must be suspended when hidden to avoid wasting CPU on invisible live preview
- `_passthrough` is a reserved profile name (built-in, auto-generated by daemon) — don't use in config.json

## System Environment

- Arch Linux, KDE Plasma (Wayland), Kernel 6.18.8-arch2-1
- Python 3.14, PySide6 6.10.2
- spacenavd (AUR), libspnav, json-c 0.18, dbus
- Blender 5.0.1, FreeCAD 1.0.2
- Hardware: 3Dconnexion SpaceNavigator (046d:c626), 6 axes, 2 buttons
